---
title: "Default priors"
output:
  rmarkdown::html_vignette:
    fig_width: 7
    fig_height: 5
vignette: >
  %\VignetteIndexEntry{Default priors}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = F}
library(knitr)
knitr::opts_chunk$set(
  out.extra = 'style="display:block; margin:auto;"'
)
```


A Gamma prior is placed on $R$, and a HalfNormal on $1 / \sqrt{k}$.
The user may specify hyperparameters of the Gamma distribution (its shape and rate) and the HalfNormal (its scale parameter).
Samples from the default prior are available in the package data object `prior_predictive` (created by [this script](https://github.com/CDCgov/nbbp/blob/main/data-raw/prior.R)), which we will use to visualize the priors.

## Default prior on $R$

The parameter $R$ is the average number of infections caused by one infected individual (that is, it is the reproduction number).

The default prior on $R$ is Gamma(shape = `r nbbp::default_res`, rate = `r nbbp::default_res`).
This has a mean of 1 and stipulates that $R$ is most likely between 1/2 and 2 (with 66.67% of prior mass in this region).
The choice of mean 1 serves to provide some prior regularization (pull) towards 1.
In regimes where $R$ is small, this should make estimation somewhat conservative, erring on the side of larger $R$.
The tradeoff is that in regimes where $R$ is large, we can under-estimate $R$.
(For simulation-based testing of such performance, see the vignettes "Simulation-based testing" and "Simulation-based calibration.")

Some might wonder why the prior on $R$ is not more informative, while others might wonder why it is not less informative.
Broadly, the prior is intended to be slightly informative while simultaneously allowing the data to express themselves in regions of $R$ which may be encountered during expected usage of this package.
Inference of $R$ from final size data under a negative binomial branching process model is strongly associated with the "stuttering chains" regime of non-sustained transmission.
This is typically a subcritical ($R < 1$) regime, though with sufficient overdispersion (see below for the effect of $k$) is is possible in the supercritical regime.

```{r, echo=FALSE, message=FALSE}
library(nbbp)
library(ggplot2)
data(prior_predictive)

prior_predictive |>
  ggplot(aes(x = r_eff, y = after_stat(density))) +
  geom_histogram() +
  theme_minimal() +
  xlab("R")
```

## Default prior on $k$

Note that the prior on $k$ is implicit (though we can still discuss it); the explicit prior is placed on $1 / \sqrt{k}$.
The choice of a HalfNormal on $1 / \sqrt{k}$ follows best-practices for a ["weakly" informative prior](https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations#story-when-the-generic-prior-fails-the-case-of-the-negative-binomial) on the NegativeBinomial over-dispersion parameter.

The parameter $k$ controls the dispersion of the offspring distribution, as well as the final size distribution, and plays a strong role in the probability of extinction of a chain.
When $k$ is _large_, there is _less_ dispersion relative to the mean, and in the limit of $k \to \infty$, the NegativeBinomial approaches the Poisson.
At $k = 1$, the NegativeBinomial coincides with the Geometric distribution.
When $k$ is small, the variance of the offspring distribution gets larger, increasing the variance of the chain size distribution.
This increase in variance also increases the probability that an individual has no offspring, increasing the extinction probability.
In the limit as $k \to 0$, all chains die out after the index case and there is no information about $R$ whatsoever.

Since both $R$ and $k$ affect the extinction probability, our inference of one affects our inference of the other.
Did the observed chains go extinct because most infections cause, on average, few new infections, or because many infections cause none at all, while others cause many?
The prior pulls towards larger $k$, which, handwavily, means the model should prefer to answer this question in terms of the mean.

The default prior has a median $k$ of 1, placing 50% of the prior mass in both the strongly-overdispersed $k < 1$ regime and the less-overdispersed $k \geq 1$ regime.

The (implicit) default prior on $k$ has heavy tails, reflecting the prior's pull towards the Poisson regime of $k \to \infty$.
Truncating to $k \leq 10$ for visualization purposes, the (conditional implicit) prior is
```{r, echo=FALSE, message=FALSE}
prior_predictive |>
  dplyr::filter(dispersion <= 10) |>
  ggplot(aes(x = dispersion, y = after_stat(density))) +
  geom_histogram() +
  theme_minimal() +
  xlab("k")
```

## Default prior predictive offspring distribution

Conditioned on $R$ and $k$, the offspring distribution is negative binomial.
By marginalizing this conditional distribution across the priors on $R$ and $k$, we obtain the prior predictive offspring distribution.
```{r, echo=FALSE, message=FALSE}
prior_predictive |>
  ggplot(aes(x = offspring_count, y = after_stat(density))) +
  geom_histogram(binwidth = 1) +
  theme_minimal() +
  coord_cartesian(xlim = c(0, 15)) +
  xlab("# offspring")
```

## Default prior predictive chain size distribution

The prior predictive distribution on chain sizes has two components.
There is a `r {round(mean(is.infinite(prior_predictive$chain_size)), 2) * 100}`% chance of a non-extinct (infinite) chain (see the vignette "Advanced data" for more on this).
Conditional on extinction (finite size), there are long tails, with a `r round(mean(prior_predictive$chain_size > 100), 2) * 100`% chance of a chain size above 100.
Focusing in on chains of 100 or fewer for visualization, the (marginal with respect to $R$ and $k$, conditional with respect to the chain size) prior distribution is:
```{r, echo=FALSE, message=FALSE}
prior_predictive |>
  dplyr::filter(chain_size <= 100) |>
  ggplot(aes(x = chain_size, y = after_stat(density))) +
  geom_histogram(binwidth = 1) +
  theme_minimal() +
  coord_cartesian(xlim = c(0, 30)) +
  xlab("chain size")
```

## Implicit default prior on `p_0`

The samples from the prior predictive offspring distribution gives us a marginal summary of the probability that an infection produces no offspring.
But we can also look at its implied prior distribution, as it is a function of $R$ and $k$.
```{r, echo=FALSE, message=FALSE}
prior_predictive |>
  dplyr::mutate(p_0 = dnbinom(0, mu = r_eff, size = dispersion)) |>
  ggplot(aes(x = p_0, y = after_stat(density))) +
  geom_histogram() +
  theme_minimal() +
  xlab("Probability of 0 offspring")
```
